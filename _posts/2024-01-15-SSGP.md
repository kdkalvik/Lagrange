---
layout: post
title: "Tutorial on streaming sparse Gaussian processes"
author: "Kalvik Jakkala"
categories: journal
tags: [machine learning, Bayesian learning, Gaussian processes]
abstract: "Walkthrough of the derivation of streaming sparse Gaussian processes [Bui et al., 2017]."
---

$$
\begin{aligned}
\hat{\mathbf{f}} &= \{ \mathbf{u}, \mathbf{f} \} \\
q_\text{new}(\hat{\mathbf{f}}) &= p(\mathbf{f}|\mathbf{u}_\text{new})q(\mathbf{u}_\text{new})
\end{aligned}
$$

---

$q_\text{old}(\hat{\mathbf{f}})$ needs to be updated to get $q_\text{new}(\hat{\mathbf{f}})$:

$$
\begin{aligned}
&\text{KL}\left[q_\text{new}(\hat{\mathbf{f}}) || p(\hat{\mathbf{f}}|\mathbf{y}_\text{old}, \mathbf{y}_\text{new})\right] = \int q_\text{new}(\hat{\mathbf{f}}) \log \left[ \frac{q_\text{new}(\hat{\mathbf{f}})}{p(\hat{\mathbf{f}}|\mathbf{y}_\text{old}, \mathbf{y}_\text{new})} \right] d\hat{\mathbf{f}} \hspace{100cm}\\
\end{aligned}
$$

<details markdown=1>
  <summary>Click for relevant identities</summary>  
---
$$
\begin{aligned}
p(\hat{\mathbf{f}}|\mathbf{y}_\text{old}) &= \frac{p(\mathbf{y}_\text{old}|\hat{\mathbf{f}})p(\hat{\mathbf{f}}|\theta_\text{old})}{\mathcal{Z}(\theta_\text{old})} \\
\implies p(\mathbf{y}_\text{old}|\hat{\mathbf{f}}) &= \frac{q_\text{old}(\hat{\mathbf{f}})\mathcal{Z}(\theta_\text{old})}{p(\hat{\mathbf{f}}|\theta_\text{old})} \\ \\
p(\hat{\mathbf{f}}|\mathbf{y}_\text{old}, \mathbf{y}_\text{new}) &= \frac{p(\mathbf{y}_\text{old}|\hat{\mathbf{f}})p(\mathbf{y}_\text{new}|\hat{\mathbf{f}})p(\hat{\mathbf{f}}|\theta_\text{new})}{\mathcal{Z}(\theta_\text{new})} \\
&= \frac{q_\text{old}(\hat{\mathbf{f}})\mathcal{Z}(\theta_\text{old})}{p(\hat{\mathbf{f}}|\theta_\text{old})} \frac{p(\mathbf{y}_\text{new}|\hat{\mathbf{f}})p(\hat{\mathbf{f}}|\theta_\text{new})}{\mathcal{Z}(\theta_\text{new})} \\
&= \frac{\mathcal{Z}(\theta_\text{old})}{\mathcal{Z}(\theta_\text{new})} p(\mathbf{y}_\text{new}|\hat{\mathbf{f}})p(\hat{\mathbf{f}}|\theta_\text{new}) \frac{q_\text{old}(\hat{\mathbf{f}})}{p(\hat{\mathbf{f}}|\theta_\text{old})} \\ \\
\end{aligned}
$$

---

</details>

$$
\begin{aligned}
&= \int q_\text{new}(\hat{\mathbf{f}}) \log \left[ \frac{q_\text{new}(\hat{\mathbf{f}})}{\frac{\mathcal{Z}(\theta_\text{old})}{\mathcal{Z}(\theta_\text{new})} p(\mathbf{y}_\text{new}|\hat{\mathbf{f}})p(\hat{\mathbf{f}}|\theta_\text{new}) \frac{q_\text{old}(\hat{\mathbf{f}})}{p(\hat{\mathbf{f}}|\theta_\text{old})}} \right] d\hat{\mathbf{f}} \\
&= \int q_\text{new}(\hat{\mathbf{f}}) \log \left[ \frac{\mathcal{Z}(\theta_\text{new})}{\mathcal{Z}(\theta_\text{old})} \right] d\hat{\mathbf{f}} + \int q_\text{new}(\hat{\mathbf{f}}) \log \left[ \frac{q_\text{new}(\hat{\mathbf{f}})}{p(\mathbf{y}_\text{new}|\hat{\mathbf{f}})p(\hat{\mathbf{f}}|\theta_\text{new}) \frac{q_\text{old}(\hat{\mathbf{f}})}{p(\hat{\mathbf{f}}|\theta_\text{old})}} \right] d\hat{\mathbf{f}} \\
&= \log \left[ \frac{\mathcal{Z}(\theta_\text{new})}{\mathcal{Z}(\theta_\text{old})} \right] + \int q_\text{new}(\hat{\mathbf{f}}) \log \left[ \frac{q_\text{new}(\hat{\mathbf{f}})}{p(\mathbf{y}_\text{new}|\hat{\mathbf{f}})p(\hat{\mathbf{f}}|\theta_\text{new}) \frac{q_\text{old}(\hat{\mathbf{f}})}{p(\hat{\mathbf{f}}|\theta_\text{old})}} \right] d\hat{\mathbf{f}} \\
\end{aligned}
$$

<details markdown=1>
  <summary>Click for relevant identity</summary>  
---
$$
\require{cancel}
\begin{aligned}
\frac{q_\text{old}(\hat{\mathbf{f}})}{p(\hat{\mathbf{f}}|\theta_\text{old})} = \frac{\cancel{p(\mathbf{f}|\mathbf{u}_\text{old})}q(\mathbf{u}_\text{old})}{\cancel{p(\mathbf{f}|\mathbf{u}_\text{old})}p(\mathbf{u}_\text{old})} = \frac{q(\mathbf{u}_\text{old})}{p(\mathbf{u}_\text{old})}
\end{aligned}
$$

---

</details>

$$
\begin{aligned}
&= \log \left[ \frac{\mathcal{Z}(\theta_\text{new})}{\mathcal{Z}(\theta_\text{old})} \right] + \int q_\text{new}(\hat{\mathbf{f}}) \log \left[ \frac{q_\text{new}(\hat{\mathbf{f}})}{p(\mathbf{y}_\text{new}|\hat{\mathbf{f}})p(\hat{\mathbf{f}}|\theta_\text{new}) \frac{q(\mathbf{u}_\text{old})}{p(\mathbf{u}_\text{old})}} \right] d\hat{\mathbf{f}} \quad \quad \\
&= \log \left[ \frac{\mathcal{Z}(\theta_\text{new})}{\mathcal{Z}(\theta_\text{old})} \right] + \int q_\text{new}(\hat{\mathbf{f}}) \log \left[ \frac{p(\mathbf{f}|\mathbf{u}_\text{new})q(\mathbf{u}_\text{new})}{p(\mathbf{y}_\text{new}|\hat{\mathbf{f}})p(\hat{\mathbf{f}}|\theta_\text{new}) \frac{q(\mathbf{u}_\text{old})}{p(\mathbf{u}_\text{old})}} \right] d\hat{\mathbf{f}} \\
&= \log \left[ \frac{\mathcal{Z}(\theta_\text{new})}{\mathcal{Z}(\theta_\text{old})} \right] + \int q_\text{new}(\hat{\mathbf{f}}) \log \left[ \frac{p(\mathbf{f}|\mathbf{u}_\text{new})q(\mathbf{u}_\text{new})p(\mathbf{u}_\text{old})}{p(\mathbf{y}_\text{new}|\hat{\mathbf{f}})p(\hat{\mathbf{f}}|\theta_\text{new}) q(\mathbf{u}_\text{old})} \right] d\hat{\mathbf{f}} \\
\end{aligned}
$$

<details markdown=1>
  <summary>Click for relevant identity</summary>  
---
$$
\begin{aligned}
p(\hat{\mathbf{f}}|\theta_\text{new}) &= p(\mathbf{f}|\mathbf{u}_\text{new})p(\mathbf{u}_\text{new}) \\
\implies \frac{p(\hat{\mathbf{f}}|\theta_\text{new})}{p(\mathbf{f}|\mathbf{u}_\text{new})} &= p(\mathbf{u}_\text{new}) \\
\implies \frac{p(\mathbf{f}|\mathbf{u}_\text{new})}{p(\hat{\mathbf{f}}|\theta_\text{new})} &= \frac{1}{p(\mathbf{u}_\text{new})} \\
\end{aligned}
$$

---

</details>

$$
\begin{aligned}
&= \log \left[ \frac{\mathcal{Z}(\theta_\text{new})}{\mathcal{Z}(\theta_\text{old})} \right] + \underbrace{\int q_\text{new}(\hat{\mathbf{f}}) \log \left[ \frac{q(\mathbf{u}_\text{new})p(\mathbf{u}_\text{old})}{p(\mathbf{y}_\text{new}|\hat{\mathbf{f}}) p(\mathbf{u}_\text{new}) q(\mathbf{u}_\text{old})} \right] d\hat{\mathbf{f}}}_{\text{Variational Free Energy } \mathcal{F}(q_\text{new}(\hat{\mathbf{f}}))} \\
\end{aligned}
$$

We can expand the VFE as follows:

$$
\begin{aligned}
\mathcal{F}(q_\text{new}(\hat{\mathbf{f}})) &= \int q_\text{new}(\hat{\mathbf{f}}) \log \left[ \frac{q(\mathbf{u}_\text{new})p(\mathbf{u}_\text{old})}{p(\mathbf{y}_\text{new}|\hat{\mathbf{f}}) p(\mathbf{u}_\text{new}) q(\mathbf{u}_\text{old})} \right] d\hat{\mathbf{f}} \hspace{100cm}\\
\end{aligned}
$$

<details markdown=1>
  <summary>Click for full derivation (⚠️ not shown in the original paper)</summary>  
---

$$
\begin{aligned}
&= \int p(\mathbf{f}|\mathbf{u}_\text{new})q(\mathbf{u}_\text{new}) \log \left[ \frac{q(\mathbf{u}_\text{new})}{p(\mathbf{u}_\text{new})}\frac{p(\mathbf{u}_\text{old})}{q(\mathbf{u}_\text{old})} \right] d\mathbf{f}d\mathbf{u}_\text{new} - \int q_\text{new}(\hat{\mathbf{f}}) \log p(\mathbf{y}_\text{new}|\hat{\mathbf{f}}) d\hat{\mathbf{f}} \\
&= \int \underbrace{p(\mathbf{f}|\mathbf{u}_\text{new})d\mathbf{f}}_{=1} q(\mathbf{u}_\text{new}) \log \left[ \frac{q(\mathbf{u}_\text{new})}{p(\mathbf{u}_\text{new})}\frac{p(\mathbf{u}_\text{old})}{q(\mathbf{u}_\text{old})} \right] d\mathbf{u}_\text{new} - \int q_\text{new}(\hat{\mathbf{f}}) \log p(\mathbf{y}_\text{new}|\hat{\mathbf{f}}) d\hat{\mathbf{f}} \\
&= \int q(\mathbf{u}_\text{new}) \log \left[ \frac{q(\mathbf{u}_\text{new})}{p(\mathbf{u}_\text{new})} \right] d\mathbf{u}_\text{new} + \int q(\mathbf{u}_\text{new}) \log \left[ \frac{p(\mathbf{u}_\text{old})}{q(\mathbf{u}_\text{old})} \right] d\mathbf{u}_\text{new} - \int q_\text{new}(\hat{\mathbf{f}}) \log p(\mathbf{y}_\text{new}|\hat{\mathbf{f}}) d\hat{\mathbf{f}} \\
&= \text{KL} \left[ q(\mathbf{u}_\text{new}) || p(\mathbf{u}_\text{new}) \right] + \int q(\mathbf{u}_\text{new}) \log \left[ \frac{p(\mathbf{u}_\text{old})}{q(\mathbf{u}_\text{old})}\frac{q(\mathbf{u}_\text{new})}{q(\mathbf{u}_\text{new})} \right] d\mathbf{u}_\text{new} - \int q_\text{new}(\hat{\mathbf{f}}) \log p(\mathbf{y}_\text{new}|\hat{\mathbf{f}}) d\hat{\mathbf{f}} \\
&= \text{KL} \left[ q(\mathbf{u}_\text{new}) || p(\mathbf{u}_\text{new}) \right] + 
\int q(\mathbf{u}_\text{new}) \log \left[ \frac{q(\mathbf{u}_\text{new})}{q(\mathbf{u}_\text{old})} \right] d\mathbf{u}_\text{new} 
-\int q(\mathbf{u}_\text{new}) \log \left[ \frac{q(\mathbf{u}_\text{new})}{p(\mathbf{u}_\text{old})} \right] d\mathbf{u}_\text{new} \\
& \quad - \int q_\text{new}(\hat{\mathbf{f}}) \log p(\mathbf{y}_\text{new}|\hat{\mathbf{f}}) d\hat{\mathbf{f}} \\
\end{aligned}
$$

---

</details>

$$
\begin{aligned}
&= \text{KL} \left[ q(\mathbf{u}_\text{new}) || p(\mathbf{u}_\text{new}) \right] 
+ \text{KL} \left[ q(\mathbf{u}_\text{new}) || q(\mathbf{u}_\text{old}) \right]
-\text{KL} \left[ q(\mathbf{u}_\text{new}) || p(\mathbf{u}_\text{old}) \right] \\
& \quad - \int q_\text{new}(\hat{\mathbf{f}}) \log p(\mathbf{y}_\text{new}|\hat{\mathbf{f}}) d\hat{\mathbf{f}} \\
\end{aligned}
$$

$$
\begin{aligned}
\end{aligned}
$$

---

# References

* <a href="https://proceedings.neurips.cc/paper/2017/hash/f31b20466ae89669f9741e047487eb37-Abstract.html" style="text-decoration: none;font-weight:bold;">Bui et al., 2017</a>
